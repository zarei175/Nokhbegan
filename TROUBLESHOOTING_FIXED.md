# راهنمای عیب‌یابی - نسخه بهبود یافته

## تغییرات اعمال شده

### ✅ بهبودهای انجام شده

1. **سیستم مدیریت خطای پیشرفته**
   - تشخیص خودکار نوع خطا
   - پیام‌های کاربرپسند به فارسی
   - لاگ‌گذاری تفصیلی در کنسول و localStorage

2. **مدیریت اتصال بهبود یافته**
   - تست اتصال با timeout
   - بررسی وجود جداول
   - سیستم retry با exponential backoff

3. **مدیریت جدول allowed_national_ids**
   - بررسی وجود جدول قبل از استفاده
   - حالت bypass اگر جدول وجود ندارد
   - پیام‌های واضح برای کاربر

4. **بهبود تجربه کاربری**
   - پیام‌های بهتر با انیمیشن
   - نشانگر بارگذاری بهبود یافته
   - دکمه بستن برای پیام‌ها

## نحوه استفاده

### 1. باز کردن پروژه

فایل `index.html` را در مرورگر باز کنید:
- دابل کلیک روی فایل
- یا drag کردن به مرورگر
- یا استفاده از Live Server

### 2. بررسی کنسول

کلید `F12` را بزنید و به تب Console بروید. حالا باید لاگ‌های تفصیلی ببینید:

```
🚀 در حال راه‌اندازی Supabase...
✅ Supabase با موفقیت راه‌اندازی شد
🔍 در حال تست اتصال به پایگاه داده...
✅ اتصال به Supabase موفقیت‌آمیز بود
🔍 در حال بررسی وجود جداول...
✅ جدول students موجود است
✅ جدول expected_students موجود است
⚠️ جدول allowed_national_ids وجود ندارد یا قابل دسترسی نیست
```

### 3. تست ثبت نام

1. فرم را با اطلاعات صحیح پر کنید
2. روی "ثبت اطلاعات" کلیک کنید
3. در کنسول پیام‌های زیر را ببینید:

```
📋 شروع فرآیند ثبت نام...
🔍 اعتبارسنجی داده‌ها...
✅ اعتبارسنجی موفق
💾 شروع ثبت در پایگاه داده...
📝 شروع فرآیند ثبت نام دانش آموز...
🔍 بررسی تکراری بودن کد ملی...
✅ کد ملی تکراری نیست
🔍 بررسی مجاز بودن کد ملی...
✅ کد ملی مجاز است
💾 در حال ذخیره اطلاعات در پایگاه داده...
✅ اطلاعات با موفقیت ذخیره شد
✅ فرآیند ثبت نام با موفقیت تکمیل شد
```

## مشکلات رایج و راه‌حل‌ها

### ❌ خطا: جدول allowed_national_ids وجود ندارد

**علت:** جدول در پایگاه داده ایجاد نشده است

**راه‌حل:**
1. به پنل Supabase بروید
2. به SQL Editor بروید
3. محتویات فایل `supabase-setup.sql` را اجرا کنید

**نکته:** سیستم حالا در حالت bypass کار می‌کند و اجازه ثبت نام می‌دهد حتی اگر این جدول وجود نداشته باشد.

### ❌ خطا: مشکل در اتصال به اینترنت

**علت:** قطع اتصال یا مشکل شبکه

**راه‌حل:**
- اتصال اینترنت را بررسی کنید
- سیستم خودکار 3 بار تلاش مجدد می‌کند
- اگر باز هم خطا داشتید، صفحه را رفرش کنید

### ❌ خطا: کد ملی تکراری

**علت:** این کد ملی قبلاً ثبت شده است

**راه‌حل:**
- از کد ملی دیگری استفاده کنید
- یا در پنل مدیریت، دانش آموز قبلی را حذف کنید

### ❌ خطا: دسترسی به پایگاه داده

**علت:** RLS policies درست تنظیم نشده‌اند

**راه‌حل:**
1. به پنل Supabase بروید
2. به Authentication > Policies بروید
3. مطمئن شوید policies برای همه جداول فعال هستند

## بررسی لاگ‌های ذخیره شده

برای دیدن لاگ‌های قبلی، در کنسول تایپ کنید:

```javascript
// دیدن 10 خطای اخیر
errorHandler.getRecentErrors(10)

// دیدن وضعیت اتصال
connectionManager.getStatus()

// پاک کردن لاگ‌ها
errorHandler.clearLog()
```

## تست دستی

### تست 1: اتصال به پایگاه داده

```javascript
await connectionManager.testConnection()
```

### تست 2: بررسی جداول

```javascript
await connectionManager.verifyTables()
```

### تست 3: ثبت نام تستی

فرم را با این اطلاعات پر کنید:
- نام: علی
- نام خانوادگی: احمدی
- کد ملی: 1234567890 (10 رقم)
- کلاس: ۷۰۱
- شماره پدر: 09123456789

## نکات مهم

1. **همیشه کنسول را باز نگه دارید** تا بتوانید خطاها را ببینید
2. **لاگ‌ها در localStorage ذخیره می‌شوند** و بعد از رفرش هم موجود هستند
3. **سیستم retry خودکار** 3 بار تلاش می‌کند قبل از نمایش خطا
4. **پیام‌های خطا به فارسی** و قابل فهم هستند

## تماس با پشتیبانی

اگر مشکل حل نشد:
1. اسکرین‌شات از کنسول بگیرید
2. لاگ‌های خطا را کپی کنید: `errorHandler.getRecentErrors()`
3. با مدیر سیستم تماس بگیرید

---

**آخرین به‌روزرسانی:** ${new Date().toLocaleDateString('fa-IR')}
**نسخه:** 2.0.0 (بهبود یافته)
