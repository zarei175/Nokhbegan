# راهنمای پیاده‌سازی سیستم اعتبارسنجی کد ملی

## خلاصه تغییرات

این پروژه قابلیت جدیدی اضافه کرده که امکان کنترل دسترسی ثبت نام دانش‌آموزان بر اساس کد ملی آن‌ها را فراهم می‌کند.

### ویژگی‌های جدید:

1. **جدول کدهای ملی مجاز**: جدول `allowed_national_ids` برای ذخیره کدهای ملی مجاز
2. **آپلود کدهای ملی از اکسل**: امکان آپلود لیست کدهای ملی از فایل Excel
3. **اعتبارسنجی در زمان ثبت نام**: بررسی خودکار کد ملی در هنگام ثبت نام
4. **مدیریت پنل ادمین**: دکمه‌های جدید برای مدیریت کدهای ملی
5. **پیام‌های خطای مناسب**: نمایش پیام‌های راهنما در صورت عدم مجاز بودن کد ملی

## مراحل پیاده‌سازی

### 1. تغییرات پایگاه داده (Supabase)

باید SQL موجود در فایل `supabase-setup.sql` را در پنل Supabase اجرا کنید:

```sql
-- جدول کدهای ملی مجاز
CREATE TABLE allowed_national_ids (
    id SERIAL PRIMARY KEY,
    national_id VARCHAR(10) UNIQUE NOT NULL,
    student_name VARCHAR(200),
    class_name VARCHAR(10),
    is_used BOOLEAN DEFAULT FALSE,
    used_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**نحوه اجرا:**
1. وارد پنل Supabase شوید
2. به قسمت SQL Editor بروید
3. محتوای فایل `supabase-setup.sql` را کپی و اجرا کنید

### 2. تست عملکرد

فایل `test-national-id-validation.html` را باز کنید تا:
- اتصال به Supabase را تست کنید
- جداول جدید را بررسی کنید
- کدهای ملی نمونه آپلود کنید
- عملکرد اعتبارسنجی را امتحان کنید

### 3. قابلیت‌های جدید در پنل مدیریت

#### آپلود کدهای ملی:
- دکمه "آپلود کدهای ملی مجاز" (قرمز)
- فرمت فایل Excel باید شامل ستون‌های زیر باشد:
  - `کد ملی`: کد ملی 10 رقمی
  - `نام دانش آموز`: نام کامل (اختیاری)
  - `کلاس`: نام کلاس (اختیاری)

#### خروجی کدهای ملی:
- دکمه "خروجی کدهای ملی مجاز" (بنفش)
- خروجی شامل تمام کدهای ملی و وضعیت استفاده آن‌ها

#### آمار جدید:
- کارت آماری جدید برای نمایش تعداد کدهای ملی مجاز

### 4. فرآیند ثبت نام جدید

وقتی دانش‌آموز کد ملی خود را وارد می‌کند:
1. **اعتبارسنجی کد ملی**: بررسی صحت ریاضی کد ملی
2. **بررسی مجاز بودن**: کد ملی باید در جدول `allowed_national_ids` موجود باشد
3. **بررسی استفاده نشده بودن**: کد ملی نباید قبلاً استفاده شده باشد
4. **ثبت موفق**: در صورت تأیید، اطلاعات ثبت و کد ملی به عنوان "استفاده شده" علامت‌گذاری می‌شود

### 5. پیام‌های خطا

- **کد ملی نامعتبر**: "کد ملی وارد شده معتبر نیست"
- **کد ملی غیرمجاز**: "کد ملی شما در لیست دانش آموزان مجاز وجود ندارد. لطفاً با مدیریت مدرسه تماس بگیرید."
- **کد ملی تکراری**: "این کد ملی قبلاً استفاده شده است!"

## فایل‌های تغییر یافته

1. **supabase-setup.sql**: اضافه شدن جدول جدید
2. **js/config.js**: اضافه شدن نام جدول و پیام‌های جدید
3. **js/supabase.js**: اضافه شدن متدهای مدیریت کد ملی
4. **js/main.js**: اضافه شدن event listener های جدید
5. **js/excel.js**: اضافه شدن قابلیت‌های آپلود/دانلود کد ملی
6. **index.html**: اضافه شدن دکمه‌ها و کارت آماری جدید
7. **css/style.css**: بهبود نمایش برای 4 کارت آماری

## نمونه فایل Excel

برای آپلود کدهای ملی، فایل Excel باید شامل ستون‌های زیر باشد:

| کد ملی | نام دانش آموز | کلاس |
|---------|---------------|-------|
| 0123456789 | علی احمدی | ۸۰۱ |
| 9876543210 | فاطمه محمدی | ۸۰۲ |
| 1234567890 | محمد رضایی | ۷۰۱ |

## نکات مهم

1. **امنیت**: تنها ادمین می‌تواند کدهای ملی را آپلود کند
2. **اعتبارسنجی**: کدهای ملی باید از نظر ریاضی صحیح باشند
3. **یکتا بودن**: هر کد ملی تنها یک بار قابل استفاده است
4. **بکاپ**: قبل از آپلود جدید، داده‌های قبلی حذف می‌شوند

## عیب‌یابی

اگر مشکلی داشتید:
1. از فایل تست برای بررسی اتصال استفاده کنید
2. مطمئن شوید جداول در Supabase ایجاد شده‌اند
3. Console برنامه را برای مشاهده خطاها بررسی کنید
4. صحت فرمت فایل Excel را بررسی کنید

---

**نکته**: این سیستم امنیت بالایی فراهم می‌کند و تنها دانش‌آموزان با کد ملی از پیش تعریف شده می‌توانند ثبت نام کنند.